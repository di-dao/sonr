version: "3"
tasks:
  # ----------------------------------------------------------------------------
  # -- Run Tasks ---------------------------------------------------------------
  # ----------------------------------------------------------------------------
  default:
    desc: Bobc is
    silent: true
    cmds:
      - task -l

  clone:
    desc: Clone the repo
    cmds:
      - bob clone --https

  build:
    silent: true
    desc: Build, tag and push the docker image
    cmds:
      - docker build -f ./docker/deploy/Dockerfile . -t sonrd

  start:
    silent: true
    desc: Start the docker image
    dir: ./docker/start
    cmds:
      - docker compose up
    deps:
      - build

  push:
    silent: true
    desc: Build, tag and push the docker image
    cmds:
      - echo "Tagging {{.IMAGE}} with {{.REGISTRY}}/{{.IMAGE}}"
      - docker tag sonrd {{.REGISTRY}}/{{.IMAGE}}:{{.VERSION}}
      - docker tag sonrd {{.REGISTRY}}/{{.IMAGE}}:{{.COMMIT}}
      - echo "Pushing {{.REGISTRY}}/{{.IMAGE}}..."
      - docker push {{.REGISTRY}}/{{.IMAGE}} --all-tags
    requires:
      vars: [IMAGE, REGISTRY]
