<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title id="title">Error</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
  <script src="./main.js"></script>

  <style>
    @font-face {
      font-family: thicccoi-regular;
      src: url("./THICCCBOI-Regular.ttf");
    }

    html,
    body {
      background-color: #0a0b38;
      color: #f5f4fa;
      font-family: "Roboto", sans-serif;
    }

    h2 {
      font-size: 42px;
    }

    .hidden {
      display: none;
    }

    .wrapper {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding-top: 6rem;
    }
  </style>

  <!-- Automatically start registration/login process -->
  <script>
    function main() {
      // Check params
      const params = new URLSearchParams(window.location.search);
      const username = params.get("username");
      const operation = params.get("operation");
      const rpOrigin = params.get("rp_origin");
      if (!username || !operation || !rpOrigin) {
        hide("processing");
        show("bad-request");
        return;
      }
      document.getElementById("title").innerHTML = `${operation
        .charAt(0)
        .toUpperCase()}${operation.substring(1)} with Sonr`;

      // Check compatability
      if (!window.PublicKeyCredential || !navigator.credentials) {
        hide("processing");
        show("unsupported");
        return;
      }

      const op = operation === "register" ? register : login;
      op(username, rpOrigin)
        .then(({ result }) => {
          console.log({ result });
          hide("prompt");
          show("processing");

          if (!result || !result.session) {
            hide("processing");
            show("failure");
            return;
          }

          const xhr = new XMLHttpRequest();
          xhr.onload = function () {
            hide("processing");
            show("success");
          };

          xhr.onerror = function () {
            hide("processing");
            show("failure");
          };

          xhr.open("POST", "/callback", false);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.send(JSON.stringify(result.session));
        })
        .catch((error) => {
          hide("processing");
          hide("prompt");
          show("failure");

          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/error", false);
          xhr.send();
        });
    }

    function register(name, rpOrigin) {
      hide("processing");
      show("prompt");
      return startUserRegistration({ name }, rpOrigin);
    }

    function login(name, rpOrigin) {
      hide("processing");
      show("prompt");
      return startUserLogin({ name }, rpOrigin);
    }

    function show(id) {
      document.getElementById(id).classList.remove("hidden");
    }

    function hide(id) {
      document.getElementById(id).classList.add("hidden");
    }
  </script>
</head>

<body onload="main()">
  <div class="wrapper">
    <h2 id="processing">Processing...</h2>

    <h2 id="unsupported" class="hidden">
      Webauthn is not supported by your browser.
    </h2>

    <h2 id="bad-request" class="hidden">Error: missing query parameters</h2>

    <h2 id="prompt" class="hidden">Waiting for FIDO...</h2>

    <div id="success" class="hidden">
      <h2>Success :)</h2>
      <h2>You can close this window.</h2>
    </div>

    <h2 id="failure" class="hidden">Failed to authenticate.</h2>
  </div>
</body>

</html>
