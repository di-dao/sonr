version: "3"
dotenv: [".env", "{{.ENV}}/.env.", "{{.HOME}}/.env"]
env:
  ENV: development
vars:
  VERSION:
    sh: echo $(git describe --tags --abbrev=0)
    default: "v0.0.0"
tasks:
  default:
    aliases:
      - "help"
    silent: true
    cmds:
      - echo ""
      - echo "⭐️ TASKFILE (sonrhq/core) ⭐️"
      - echo ""
      - task --list

  deps:
    desc: Install dependencies
    summary: |
      Install Dependencies

      This task will install the dependencies
    cmds:
      - npm i -g concurrently
      -

  build:
    desc: Build the binary for the current platform
    summary: |
      Build Binary

      This task will build the binary for the current platform
    cmds:
      - ignite chain build
    interactive: true

  chain:
    desc: Serve the blockchain locally with verbose logging
    aliases:
      - "srv"
    summary: |
      Serve Blockchain Locally

      This task will serve the blockchain locally. It will also reset the blockchain
    cmds:
      - ignite chain serve --clear-cache --reset-once -v
    interactive: true

  generate:
    aliases:
      - "gen"
    desc: Generate the protobuf files
    summary: |
      Generate Protobuf Files

      This task will generate the protobuf files
    cmds:
      - ignite generate proto-go -y

  docker:build:
    desc: Build the docker image
    summary: |
      Build Docker Image

      This task will build the docker image
    cmds:
      - docker build -t sonr .
      - docker tag sonr ghcr.io/sonrhq/sonrd:latest
      - docker tag sonr ghcr.io/sonrhq/sonrd:{{.VERSION}}

  docker:push:
    aliases:
      - "docker"
    desc: Push the docker image
    summary: |
      Push Docker Image

      This task will push the docker image
    cmds:
      - docker push ghcr.io/sonrhq/sonrd:latest
      - docker push ghcr.io/sonrhq/sonrd:{{.VERSION}}
    deps:
      - docker:build

  db:
    desc: Run the database locally
    dir: ./.tmp/bin
    summary: |
      Run Database Locally

      This task will run the database locally
    cmds:
      - ./IceFireDB start

  db:install:
    desc: Install the database locally
    dir: ./.tmp
    summary: |
      Install Database Locally

      This task will install the database locally
    cmds:
      - mkdir -p ./bin
      - git clone https://github.com/sonrhq/IceFireDB.git IceFireDB
      - make -C ./IceFireDB
      - mv ./IceFireDB/bin/IceFireDB ./bin/IceFireDB
      - rm -rf ./IceFireDB

  serve:
    desc: Serve the Blockchain and Database locally
    summary: |
      Serve Blockchain and Database Locally

      This task will serve the blockchain and database locally
    cmds:
      - rm -rf ./.tmp
      - mkdir -p ./.tmp
      - task: db:install
      - conc "task chain" "task db" -n "chain,db" -g -r
