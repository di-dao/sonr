package handler

import (
	"context"
	"fmt"

	"github.com/cosmos/cosmos-sdk/client"
	mdw "github.com/sonrhq/core/internal/highway/middleware"
	"github.com/sonrhq/core/internal/highway/types"
	authenticationpb "github.com/sonrhq/core/types/highway/authentication/v1"
	domainproxy "github.com/sonrhq/core/x/domain/client/proxy"
	identityproxy "github.com/sonrhq/core/x/identity/client/proxy"
	serviceproxy "github.com/sonrhq/core/x/service/client/proxy"
	emptypb "google.golang.org/protobuf/types/known/emptypb"
)

// AuthentactionAPI is an alias for the AuthenticationServiceServer interface generated by protoc-gen-go-grpc.
type AuthentactionAPI = authenticationpb.AuthenticationServiceServer

// AuthenticationHandler is the handler for the authentication service
type AuthenticationHandler struct {
	cctx client.Context
}

// ! ||--------------------------------------------------------------------------------||
// ! ||                                   API Methods                                  ||
// ! ||--------------------------------------------------------------------------------||

// Authenticate handles the authentication request
func (a *AuthenticationHandler) Authenticate(ctx context.Context, req *authenticationpb.AuthenticateRequest) (*authenticationpb.AuthenticateResponse, error) {
	record, err := serviceproxy.GetServiceRecord(ctx, req.Origin)
	if err != nil {
		return nil, err
	}
	_, err = record.VerifyAssertionChallenge(req.Assertion)
	if err != nil {
		return nil, err
	}
	addr, err := domainproxy.GetEmailRecordCreator(ctx, req.Alias)
	if err != nil {
		return nil, err
	}
	contAcc, err := identityproxy.GetControllerAccount(ctx, addr)
	if err != nil {
		return nil, err
	}
	token, err := types.NewSessionJWTClaims(req.Alias, contAcc)
	if err != nil {
		return nil, err
	}
	return &authenticationpb.AuthenticateResponse{
		Origin:  req.Origin,
		Address: contAcc.Address,
		Jwt:     token,
	}, nil
}

func (a *AuthenticationHandler) CurrentUser(ctx context.Context, req *emptypb.Empty) (*authenticationpb.CurrentUserResponse, error) {
	return nil, fmt.Errorf("not implemented")
}

func (a *AuthenticationHandler) Params(ctx context.Context, req *authenticationpb.ParamsRequest) (*authenticationpb.ParamsResponse, error) {
	if req.IsLogin {
		return mdw.GetCredentialAssertionOptions(ctx, req.Origin, req.Alias)
	}
	return mdw.GetCredentialAttestationParams(ctx, req.Origin, req.Alias)
}

func (a *AuthenticationHandler) Register(ctx context.Context, req *authenticationpb.RegisterRequest) (*authenticationpb.RegisterResponse, error) {
	// Get the service record from the origin
	record, err := serviceproxy.GetServiceRecord(ctx, req.Origin)
	if err != nil {
		return nil, err
	}
	credential, err := record.VerifyCreationChallenge(req.Attestation, req.Challenge)
	if err != nil && credential == nil {
		return nil, err
	}
	cont, resp, err := mdw.PublishControllerAccount(req.Username, credential, req.Origin)
	if err != nil {
		return nil, err
	}
	token, err := types.NewSessionJWTClaims(req.Username, cont.Account())
	if err != nil {
		return nil, err
	}
	return &authenticationpb.RegisterResponse{
		Origin:  req.Origin,
		Address: cont.Account().Address,
		Jwt:     token,
		TxHash:  resp.TxHash,
	}, nil
}

func (a *AuthenticationHandler) RefreshToken(ctx context.Context, req *authenticationpb.RefreshTokenRequest) (*authenticationpb.RefreshTokenResponse, error) {
	return nil, nil
}

func (a *AuthenticationHandler) VerifyToken(ctx context.Context, req *authenticationpb.VerifyTokenRequest) (*authenticationpb.VerifyTokenResponse, error) {
	return nil, nil
}
